generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  COACH
  ADMIN
}

enum UserMode {
  USER
  COACH
}

enum TrainingGoal {
  STRENGTH
  HYPERTROPHY
  MIXED
}

enum ExperienceLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum ExerciseGroupType {
  SINGLE
  SUPERSET_2
  SUPERSET_3
}

enum WorkoutSessionStatus {
  ACTIVE
  PAUSED
  FINISHED
}

model User {
  id                 String           @id @default(uuid())
  email              String           @unique
  password_hash      String
  full_name          String
  role               UserRole         @default(USER)
  preferred_modes    UserMode[]       @default([USER])
  active_mode        UserMode         @default(USER)
  goal               TrainingGoal?
  experience_level   ExperienceLevel?
  days_per_week      Int?
  session_minutes    Int?
  injuries           String?
  equipment          String[]         @default([])
  active_routine_id  String?
  active_routine     Routine?         @relation("ActiveRoutine", fields: [active_routine_id], references: [id], onDelete: SetNull)
  refresh_token_hash String?
  created_exercises  Exercise[]
  routines           Routine[]         @relation("OwnedRoutines")
  workout_sessions   WorkoutSession[]
  coached_assignments  RoutineAssignment[]  @relation("CoachAssignments")
  user_assignments     RoutineAssignment[]  @relation("UserAssignments")
  routine_reviews      RoutineReview[]
  following_coaches    CoachFollow[]        @relation("UserFollowsCoach")
  coach_followers      CoachFollow[]        @relation("CoachFollowedByUsers")
  ai_recommendation_logs AiRecommendationLog[] @relation("AiRecommendationUser")
  ai_coach_logs          AiRecommendationLog[] @relation("AiRecommendationCoach")
  ai_applied_suggestions AiAppliedSuggestion[] @relation("AiAppliedByUser")
  created_at         DateTime         @default(now())
  updated_at         DateTime         @updatedAt
}

model Exercise {
  id             String          @id @default(uuid())
  name           String          @unique
  muscle_group   String
  equipment      String?
  instructions   String?
  created_by_id  String?
  created_by     User?           @relation(fields: [created_by_id], references: [id])
  group_exercise GroupExercise[]
  created_at     DateTime        @default(now())
  updated_at     DateTime        @updatedAt
}

model Routine {
  id          String           @id @default(uuid())
  owner_id    String
  owner       User             @relation("OwnedRoutines", fields: [owner_id], references: [id])
  name        String
  description String?
  is_public   Boolean          @default(false)
  published_at DateTime?
  marketplace_title String?
  marketplace_goal  String?
  marketplace_level String?
  marketplace_days_per_week Int?
  marketplace_duration_weeks Int?
  marketplace_description String?
  marketplace_tags String[]           @default([])
  rating_average Float         @default(0)
  rating_count   Int           @default(0)
  days        RoutineDay[]
  sessions    WorkoutSession[]
  assignments RoutineAssignment[]
  active_for_users User[]      @relation("ActiveRoutine")
  reviews     RoutineReview[]
  ai_applied_suggestions AiAppliedSuggestion[]
  created_at  DateTime         @default(now())
  updated_at  DateTime         @updatedAt

  @@index([is_public, published_at])
}

model RoutineReview {
  id          String   @id @default(uuid())
  routine_id  String
  routine     Routine  @relation(fields: [routine_id], references: [id], onDelete: Cascade)
  user_id     String
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  rating      Int
  review      String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@unique([routine_id, user_id])
  @@index([routine_id, created_at])
}

model CoachFollow {
  id          String   @id @default(uuid())
  user_id     String
  user        User     @relation("UserFollowsCoach", fields: [user_id], references: [id], onDelete: Cascade)
  coach_id    String
  coach       User     @relation("CoachFollowedByUsers", fields: [coach_id], references: [id], onDelete: Cascade)
  created_at  DateTime @default(now())

  @@unique([user_id, coach_id])
  @@index([coach_id, created_at])
}

model RoutineDay {
  id               String           @id @default(uuid())
  routine_id       String
  routine          Routine          @relation(fields: [routine_id], references: [id], onDelete: Cascade)
  day_label        String
  order_index      Int
  groups           ExerciseGroup[]
  workout_sessions WorkoutSession[]
  ai_applied_suggestions AiAppliedSuggestion[]
}

model ExerciseGroup {
  id                             String            @id @default(uuid())
  routine_day_id                 String
  routine_day                    RoutineDay        @relation(fields: [routine_day_id], references: [id], onDelete: Cascade)
  type                           ExerciseGroupType
  order_index                    Int
  rounds_total                   Int
  rest_between_exercises_seconds Int               @default(0)
  rest_after_round_seconds       Int               @default(0)
  rest_after_set_seconds         Int?
  exercises                      GroupExercise[]
}

model GroupExercise {
  id                    String        @id @default(uuid())
  exercise_group_id     String
  exercise_group        ExerciseGroup @relation(fields: [exercise_group_id], references: [id], onDelete: Cascade)
  exercise_id           String
  exercise              Exercise      @relation(fields: [exercise_id], references: [id])
  order_in_group        String
  target_sets_per_round Int
  rep_range_min         Int?
  rep_range_max         Int?
  rep_range             String
  notes                 String?
}

model RoutineAssignment {
  id         String   @id @default(uuid())
  coach_id   String
  coach      User     @relation("CoachAssignments", fields: [coach_id], references: [id], onDelete: Cascade)
  user_id    String
  user       User     @relation("UserAssignments", fields: [user_id], references: [id], onDelete: Cascade)
  routine_id String
  routine    Routine  @relation(fields: [routine_id], references: [id], onDelete: Cascade)
  is_active  Boolean  @default(true)
  start_date DateTime @default(now())
  coach_notes String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([coach_id, user_id, routine_id])
  @@index([user_id, is_active])
  @@index([coach_id, is_active])
}

model WorkoutSession {
  id                                      String               @id @default(uuid())
  user_id                                 String
  user                                    User                 @relation(fields: [user_id], references: [id])
  routine_id                              String
  routine                                 Routine              @relation(fields: [routine_id], references: [id])
  routine_day_id                          String
  routine_day                             RoutineDay           @relation(fields: [routine_day_id], references: [id])
  status                                  WorkoutSessionStatus @default(ACTIVE)
  started_at                              DateTime             @default(now())
  ended_at                                DateTime?
  current_pointer                         Json?
  override_rest_between_exercises_seconds Int?
  override_rest_after_round_seconds       Int?
  override_rest_after_set_seconds         Int?
  workout_groups                          WorkoutGroup[]
  processed_events                        WorkoutProcessedEvent[]
}

model WorkoutGroup {
  id                             String                @id @default(uuid())
  workout_session_id             String
  workout_session                WorkoutSession        @relation(fields: [workout_session_id], references: [id], onDelete: Cascade)
  source_group_id                String
  type                           ExerciseGroupType
  order_index                    Int
  rounds_total                   Int
  round_current                  Int                   @default(1)
  rest_between_exercises_seconds Int                   @default(0)
  rest_after_round_seconds       Int                   @default(0)
  rest_after_set_seconds         Int?
  workout_items                  WorkoutExerciseItem[]
}

model WorkoutExerciseItem {
  id                       String       @id @default(uuid())
  workout_group_id         String
  workout_group            WorkoutGroup @relation(fields: [workout_group_id], references: [id], onDelete: Cascade)
  source_group_exercise_id String
  order_in_group           String
  target_sets_total        Int
  rep_range                String
  notes                    String?
  sets                     WorkoutSet[]
}

model WorkoutSet {
  id                       String              @id @default(uuid())
  workout_exercise_item_id String
  workout_exercise_item    WorkoutExerciseItem @relation(fields: [workout_exercise_item_id], references: [id], onDelete: Cascade)
  set_number               Int
  weight                   Float?
  reps                     Int?
  rpe                      Float?
  completed_at             DateTime?
  is_done                  Boolean             @default(false)
}

model WorkoutProcessedEvent {
  session_id String
  event_id   String
  created_at DateTime @default(now())

  session WorkoutSession @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@id([session_id, event_id])
}

model AiRecommendationLog {
  id               String   @id @default(uuid())
  user_id          String
  user             User     @relation("AiRecommendationUser", fields: [user_id], references: [id], onDelete: Cascade)
  coach_id         String?
  coach            User?    @relation("AiRecommendationCoach", fields: [coach_id], references: [id], onDelete: SetNull)
  request_payload  Json
  response_payload Json
  safety_flags     String[]
  request_hash     String?
  dedup_hit        Boolean  @default(false)
  rate_limited     Boolean  @default(false)
  latency_ms       Int?
  model_version    String
  strategy_version String   @default("3.2.0")
  applied_suggestions AiAppliedSuggestion[]
  created_at       DateTime @default(now())

  @@index([user_id, created_at])
  @@index([coach_id, created_at])
  @@index([request_hash, created_at])
}

model AiAppliedSuggestion {
  id                 String              @id @default(uuid())
  ai_log_id          String
  ai_log             AiRecommendationLog @relation(fields: [ai_log_id], references: [id], onDelete: Cascade)
  routine_id         String
  routine            Routine             @relation(fields: [routine_id], references: [id], onDelete: Cascade)
  routine_day_id     String
  routine_day        RoutineDay          @relation(fields: [routine_day_id], references: [id], onDelete: Cascade)
  applied_by_user_id String
  applied_by_user    User                @relation("AiAppliedByUser", fields: [applied_by_user_id], references: [id], onDelete: Cascade)
  applied_changes    Json
  created_at         DateTime            @default(now())

  @@index([routine_id, routine_day_id, created_at])
  @@index([ai_log_id, created_at])
}
